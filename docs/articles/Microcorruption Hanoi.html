<!doctype html>
<html lang="en">
	<head>
		<meta charset="utf-8" />
		<meta name="viewport" content="width=device-width, initial-scale=1" />
		
		<link href="../_app/immutable/assets/0.Dlb7pXDV.css" rel="stylesheet">
		<link href="../_app/immutable/assets/4.CimdS63P.css" rel="stylesheet">
		<link rel="modulepreload" href="../_app/immutable/entry/start.CA_wHMO-.js">
		<link rel="modulepreload" href="../_app/immutable/chunks/DD8_7pLE.js">
		<link rel="modulepreload" href="../_app/immutable/chunks/DCFcRc6v.js">
		<link rel="modulepreload" href="../_app/immutable/chunks/BqHloRb4.js">
		<link rel="modulepreload" href="../_app/immutable/entry/app.TGZ1RBKz.js">
		<link rel="modulepreload" href="../_app/immutable/chunks/C6U3RdpY.js">
		<link rel="modulepreload" href="../_app/immutable/chunks/Dwf-VV-B.js">
		<link rel="modulepreload" href="../_app/immutable/chunks/CBZjZzat.js">
		<link rel="modulepreload" href="../_app/immutable/nodes/0.VfO5N2ud.js">
		<link rel="modulepreload" href="../_app/immutable/chunks/D4n077k-.js">
		<link rel="modulepreload" href="../_app/immutable/chunks/DhnXOQm4.js">
		<link rel="modulepreload" href="../_app/immutable/chunks/Dn8mKSux.js">
		<link rel="modulepreload" href="../_app/immutable/nodes/4.DlvMBQ3k.js">
		<link rel="modulepreload" href="../_app/immutable/chunks/jRw7-Y13.js"><!--[--><!--]--><title>Microcorruption Hanoi</title>
	</head>
	<body data-sveltekit-preload-data="hover" style="background-color:  #E9E9DF;">
		<div style="display: contents"><!--[--><!--[--><!----><div class="site-header svelte-8v83zk"><h1 id="site-title" class="svelte-8v83zk"> Anoth3r Site</h1> <h1 class="blink svelte-8v83zk">_</h1></div> <hr class="hr-top svelte-8v83zk"> <div class="svelte-8v83zk"><ul class="nav-bar svelte-8v83zk"><li class="svelte-8v83zk"><a href="/" class="svelte-8v83zk">Home</a></li> <li class="svelte-8v83zk"><a href="/about" class="svelte-8v83zk">About</a></li> <li class="svelte-8v83zk"><a href="https://github.com/fl1gg" class="svelte-8v83zk">Github</a></li> <li class="svelte-8v83zk"><a href="/contact" class="svelte-8v83zk">Contact</a></li></ul></div> <br class="svelte-8v83zk"><!----> <!----><div class="articles svelte-1oy2dsc"><div class="header svelte-1oy2dsc"><h1 class="title svelte-1oy2dsc">Microcorruption Hanoi</h1> <p class="subtitle svelte-1oy2dsc">The process and solution for the third Microcorruption level</p></div> <div class="tags svelte-1oy2dsc"><!--[--><span class="tag svelte-1oy2dsc">#microcorruption</span><span class="tag svelte-1oy2dsc">#reversing</span><span class="tag svelte-1oy2dsc">#pwn</span><!--]--></div> <br class="svelte-1oy2dsc"> <hr class="svelte-1oy2dsc"> <div id="page" class="svelte-1oy2dsc"><!----><p>Here is the manual for Microcorruption which we will need for this challenge:</p> <ul><li>Manual: <a href="https://microcorruption.com/public/manual.pdf" rel="nofollow">https://microcorruption.com/public/manual.pdf</a></li></ul> <p>Additionally, the MSP430 specific booklets:</p> <ul><li>User Guide: <a href="https://www.ti.com/lit/ug/slau049f/slau049f.pdf" rel="nofollow">https://www.ti.com/lit/ug/slau049f/slau049f.pdf</a></li> <li>ABI: <a href="https://www.ti.com/lit/an/slaa534a/slaa534a.pdf" rel="nofollow">https://www.ti.com/lit/an/slaa534a/slaa534a.pdf</a></li></ul> <p>Alright, when we select this challenge we are given some new information:</p> <!----><pre class="shiki github-dark-default" style="background-color:#0d1117;color:#e6edf3" tabindex="0"><code><span class="line"><span>LockIT Pro Hardware  Security Module 1 stores  the login password,</span></span>
<span class="line"><span>ensuring users  can not access  the password through  other means.</span></span>
<span class="line"><span>The LockIT Pro  can send the LockIT Pro HSM-1  a password, and the</span></span>
<span class="line"><span>HSM will  return if the password  is correct by setting  a flag in</span></span>
<span class="line"><span>memory.</span></span>
<span class="line"><span></span></span>
<span class="line"><span>This is Hardware  Version B.  It contains  the Bluetooth connector</span></span>
<span class="line"><span>built in, and two available  ports: the LockIT Pro Deadbolt should</span></span>
<span class="line"><span>be  connected to  port  1,  and the  LockIT  Pro  HSM-1 should  be</span></span>
<span class="line"><span>connected to port 2.</span></span>
<span class="line"><span></span></span>
<span class="line"><span>This is Software Revision 01,  allowing it to communicate with the</span></span>
<span class="line"><span>LockIT Pro HSM-1</span></span></code></pre><!----> <p>It also appears the main function has also changed significantly. It is now just calling a function login:</p> <!----><pre class="shiki github-dark-default" style="background-color:#0d1117;color:#e6edf3" tabindex="0"><code><span class="line"><span style="color:#79C0FF">4438</span><span style="color:#E6EDF3"> &#x3C;main></span></span>
<span class="line"><span style="color:#79C0FF">4438</span><span style="color:#E6EDF3">:  b012 </span><span style="color:#79C0FF">2045</span><span style="color:#FF7B72">      call</span><span style="color:#E6EDF3">	#</span><span style="color:#79C0FF">0x4520</span><span style="color:#E6EDF3"> &#x3C;login></span></span>
<span class="line"><span style="color:#FFA198;font-style:italic">443c:</span><span style="color:#E6EDF3">  0f43           clr	</span><span style="color:#79C0FF">r15</span></span></code></pre><!----> <p>Looking through the login function we can determine that the unlock door function will be called if the value at the address 2410 is 0x9a. We also need to ensure the test_password_valid function returns 0 into r15.</p> <!----><pre class="shiki github-dark-default" style="background-color:#0d1117;color:#e6edf3" tabindex="0"><code><span class="line"><span style="color:#79C0FF">4520</span><span style="color:#E6EDF3"> &#x3C;login></span></span>
<span class="line"></span>
<span class="line"><span style="color:#79C0FF">4520</span><span style="color:#E6EDF3">:  c243 </span><span style="color:#79C0FF">1024</span><span style="color:#FF7B72">      mov</span><span style="color:#E6EDF3">.b	#</span><span style="color:#79C0FF">0x0</span><span style="color:#E6EDF3">, &#x26;</span><span style="color:#79C0FF">0x2410</span><span style="color:#8B949E">                                       ; move 0 (1 byte) into memory address 2410 (string terminator)</span></span>
<span class="line"><span style="color:#79C0FF">4524</span><span style="color:#E6EDF3">:  3f40 </span><span style="color:#79C0FF">7e44</span><span style="color:#FF7B72">      mov</span><span style="color:#E6EDF3">	#</span><span style="color:#79C0FF">0x447e</span><span style="color:#E6EDF3"> "</span><span style="color:#FF7B72">Enter</span><span style="color:#E6EDF3"> the password to continue.", </span><span style="color:#79C0FF">r15</span><span style="color:#8B949E">      ; move address 447e into register r15</span></span>
<span class="line"><span style="color:#79C0FF">4528</span><span style="color:#E6EDF3">:  b012 de45      </span><span style="color:#FF7B72">call</span><span style="color:#E6EDF3">	#</span><span style="color:#79C0FF">0x45de</span><span style="color:#E6EDF3"> &#x3C;puts>                                      </span><span style="color:#8B949E">; print to screen</span></span>
<span class="line"><span style="color:#FFA198;font-style:italic">452c:</span><span style="color:#E6EDF3">  3f40 </span><span style="color:#79C0FF">9e44</span><span style="color:#FF7B72">      mov</span><span style="color:#E6EDF3">	#</span><span style="color:#79C0FF">0x449e</span><span style="color:#E6EDF3"> "</span><span style="color:#D2A8FF">Remember:</span><span style="color:#E6EDF3"> passwords are between </span><span style="color:#79C0FF">8</span><span style="color:#FF7B72"> and</span><span style="color:#79C0FF"> 16</span><span style="color:#E6EDF3"> characters.", </span><span style="color:#79C0FF">r15</span><span style="color:#8B949E">    ; move address 449e into r15</span></span>
<span class="line"><span style="color:#79C0FF">4530</span><span style="color:#E6EDF3">:  b012 de45      </span><span style="color:#FF7B72">call</span><span style="color:#E6EDF3">	#</span><span style="color:#79C0FF">0x45de</span><span style="color:#E6EDF3"> &#x3C;puts>                                      </span><span style="color:#8B949E">; print to screen</span></span>
<span class="line"><span style="color:#79C0FF">4534</span><span style="color:#E6EDF3">:  </span><span style="color:#79C0FF">3e40</span><span style="color:#E6EDF3"> 1c00      </span><span style="color:#FF7B72">mov</span><span style="color:#E6EDF3">	#</span><span style="color:#79C0FF">0x1c</span><span style="color:#E6EDF3">, </span><span style="color:#79C0FF">r14</span><span style="color:#8B949E">                                          ; move 0x1c into register r14</span></span>
<span class="line"><span style="color:#79C0FF">4538</span><span style="color:#E6EDF3">:  3f40 </span><span style="color:#79C0FF">0024</span><span style="color:#FF7B72">      mov</span><span style="color:#E6EDF3">	#</span><span style="color:#79C0FF">0x2400</span><span style="color:#E6EDF3">, </span><span style="color:#79C0FF">r15</span><span style="color:#8B949E">                                        ; move address 2400 into register r15</span></span>
<span class="line"><span style="color:#FFA198;font-style:italic">453c:</span><span style="color:#E6EDF3">  b012 ce45      </span><span style="color:#FF7B72">call</span><span style="color:#E6EDF3">	#</span><span style="color:#79C0FF">0x45ce</span><span style="color:#E6EDF3"> &#x3C;getsn>                                     </span><span style="color:#8B949E">; put user input [string] into memory address (should be terminated at 2410)</span></span>
<span class="line"><span style="color:#79C0FF">4540</span><span style="color:#E6EDF3">:  3f40 </span><span style="color:#79C0FF">0024</span><span style="color:#FF7B72">      mov</span><span style="color:#E6EDF3">	#</span><span style="color:#79C0FF">0x2400</span><span style="color:#E6EDF3">, </span><span style="color:#79C0FF">r15</span><span style="color:#8B949E">                                        ; reset register r15 to the beginning of the user input</span></span>
<span class="line"><span style="color:#79C0FF">4544</span><span style="color:#E6EDF3">:  b012 </span><span style="color:#79C0FF">5444</span><span style="color:#FF7B72">      call</span><span style="color:#E6EDF3">	#</span><span style="color:#79C0FF">0x4454</span><span style="color:#E6EDF3"> &#x3C;test_password_valid>                       </span><span style="color:#8B949E">; r15 is the parameter passed to the test_password_valid function</span></span>
<span class="line"><span style="color:#79C0FF">4548</span><span style="color:#E6EDF3">:  0f93           tst	</span><span style="color:#79C0FF">r15</span><span style="color:#8B949E">                                                 ; r15 is also the output</span></span>
<span class="line"><span style="color:#FFA198;font-style:italic">454a:</span><span style="color:#79C0FF">  0324</span><span style="color:#FF7B72">           jz</span><span style="color:#E6EDF3">	$+</span><span style="color:#79C0FF">0x8</span><span style="color:#E6EDF3"> &#x3C;login+</span><span style="color:#79C0FF">0x32</span><span style="color:#E6EDF3">>                                  </span><span style="color:#8B949E">; if r15 is zero, then jump to 4552 (skipping the next line)</span></span>
<span class="line"><span style="color:#FFA198;font-style:italic">454c:</span><span style="color:#E6EDF3">  f240 a800 </span><span style="color:#79C0FF">1024</span><span style="color:#FF7B72"> mov</span><span style="color:#E6EDF3">.b	#</span><span style="color:#79C0FF">0xa8</span><span style="color:#E6EDF3">, &#x26;</span><span style="color:#79C0FF">0x2410</span><span style="color:#8B949E">                                      ; set the value at 2410 to 0xa8</span></span>
<span class="line"><span style="color:#79C0FF">4552</span><span style="color:#E6EDF3">:  3f40 d344      </span><span style="color:#FF7B72">mov</span><span style="color:#E6EDF3">	#</span><span style="color:#79C0FF">0x44d3</span><span style="color:#E6EDF3"> "Testing if password is valid.", </span><span style="color:#79C0FF">r15</span><span style="color:#8B949E">        ; put a string location into r15</span></span>
<span class="line"><span style="color:#79C0FF">4556</span><span style="color:#E6EDF3">:  b012 de45      </span><span style="color:#FF7B72">call</span><span style="color:#E6EDF3">	#</span><span style="color:#79C0FF">0x45de</span><span style="color:#E6EDF3"> &#x3C;puts>                                      </span><span style="color:#8B949E">; and print it</span></span>
<span class="line"><span style="color:#FFA198;font-style:italic">455a:</span><span style="color:#E6EDF3">  f290 9a00 </span><span style="color:#79C0FF">1024</span><span style="color:#FF7B72"> cmp</span><span style="color:#E6EDF3">.b	#</span><span style="color:#79C0FF">0x9a</span><span style="color:#E6EDF3">, &#x26;</span><span style="color:#79C0FF">0x2410</span><span style="color:#8B949E">                                      ; check if the value at address 2410 is 0x9a (notice if we were wrong about the password this address was set by)</span></span>
<span class="line"><span style="color:#79C0FF">4560</span><span style="color:#E6EDF3">:  </span><span style="color:#79C0FF">0720</span><span style="color:#FF7B72">           jnz</span><span style="color:#E6EDF3">	$+</span><span style="color:#79C0FF">0x10</span><span style="color:#E6EDF3"> &#x3C;login+</span><span style="color:#79C0FF">0x50</span><span style="color:#E6EDF3">>                                 </span><span style="color:#8B949E">; if they are not equal jump to address 4570</span></span>
<span class="line"><span style="color:#79C0FF">4562</span><span style="color:#E6EDF3">:  3f40 f144      </span><span style="color:#FF7B72">mov</span><span style="color:#E6EDF3">	#</span><span style="color:#79C0FF">0x44f1</span><span style="color:#E6EDF3"> "Access granted.", </span><span style="color:#79C0FF">r15</span><span style="color:#8B949E">                      ; put a string address into r15</span></span>
<span class="line"><span style="color:#79C0FF">4566</span><span style="color:#E6EDF3">:  b012 de45      </span><span style="color:#FF7B72">call</span><span style="color:#E6EDF3">	#</span><span style="color:#79C0FF">0x45de</span><span style="color:#E6EDF3"> &#x3C;puts>                                      </span><span style="color:#8B949E">; print that string</span></span>
<span class="line"><span style="color:#FFA198;font-style:italic">456a:</span><span style="color:#E6EDF3">  b012 </span><span style="color:#79C0FF">4844</span><span style="color:#FF7B72">      call</span><span style="color:#E6EDF3">	#</span><span style="color:#79C0FF">0x4448</span><span style="color:#E6EDF3"> &#x3C;unlock_door>                               </span><span style="color:#8B949E">; unlock the door</span></span>
<span class="line"><span style="color:#FFA198;font-style:italic">456e:</span><span style="color:#79C0FF">  3041</span><span style="color:#FF7B72">           ret</span><span style="color:#8B949E">                                                           ; return</span></span>
<span class="line"><span style="color:#79C0FF">4570</span><span style="color:#E6EDF3">:  3f40 </span><span style="color:#79C0FF">0145</span><span style="color:#FF7B72">      mov</span><span style="color:#E6EDF3">	#</span><span style="color:#79C0FF">0x4501</span><span style="color:#E6EDF3"> "That password is </span><span style="color:#FF7B72">not</span><span style="color:#E6EDF3"> correct.", </span><span style="color:#79C0FF">r15</span><span style="color:#8B949E">        ; put a string into r15</span></span>
<span class="line"><span style="color:#79C0FF">4574</span><span style="color:#E6EDF3">:  b012 de45      </span><span style="color:#FF7B72">call</span><span style="color:#E6EDF3">	#</span><span style="color:#79C0FF">0x45de</span><span style="color:#E6EDF3"> &#x3C;puts>                                      </span><span style="color:#8B949E">; print that string </span></span>
<span class="line"><span style="color:#79C0FF">4578</span><span style="color:#E6EDF3">:  </span><span style="color:#79C0FF">3041</span><span style="color:#FF7B72">           ret</span><span style="color:#8B949E">                                                           ; return</span></span></code></pre><!----> <p>So we know that we can overflow the address 2410, as the input we supply is not checked for length. That solved our first problem. However, we now need to find a way to make test_password_valid return zero.</p> <!----><pre class="shiki github-dark-default" style="background-color:#0d1117;color:#e6edf3" tabindex="0"><code><span class="line"><span style="color:#79C0FF">4454</span><span style="color:#E6EDF3"> &#x3C;test_password_valid></span></span>
<span class="line"><span style="color:#79C0FF">4454</span><span style="color:#E6EDF3">:  </span><span style="color:#79C0FF">0412</span><span style="color:#FF7B72">           push</span><span style="color:#E6EDF3">	r4                    </span><span style="color:#8B949E">; store current value of r4 on stack so we can use it</span></span>
<span class="line"><span style="color:#79C0FF">4456</span><span style="color:#E6EDF3">:  </span><span style="color:#79C0FF">0441</span><span style="color:#FF7B72">           mov</span><span style="color:#79C0FF">	sp</span><span style="color:#E6EDF3">, r4                </span><span style="color:#8B949E">; move the stack pointer into r4</span></span>
<span class="line"><span style="color:#79C0FF">4458</span><span style="color:#E6EDF3">:  </span><span style="color:#79C0FF">2453</span><span style="color:#E6EDF3">           incd	r4                    </span><span style="color:#8B949E">; move the pointer in r4 one word (2 bytes) into the stack (reference second to last variable)</span></span>
<span class="line"><span style="color:#FFA198;font-style:italic">445a:</span><span style="color:#79C0FF">  2183</span><span style="color:#E6EDF3">           decd	</span><span style="color:#79C0FF">sp</span><span style="color:#8B949E">                    ; add space to the stack, stack grows to lower memory addresses</span></span>
<span class="line"><span style="color:#FFA198;font-style:italic">445c:</span><span style="color:#E6EDF3">  c443 fcff      </span><span style="color:#FF7B72">mov</span><span style="color:#E6EDF3">.b	#</span><span style="color:#79C0FF">0x0</span><span style="color:#E6EDF3">, -</span><span style="color:#79C0FF">0x4</span><span style="color:#E6EDF3">(r4)        </span><span style="color:#8B949E">; move a byte of zero into the space we created on the stack (2nd variable on stack)</span></span>
<span class="line"><span style="color:#79C0FF">4460</span><span style="color:#E6EDF3">:  </span><span style="color:#79C0FF">3e40</span><span style="color:#E6EDF3"> fcff      </span><span style="color:#FF7B72">mov</span><span style="color:#E6EDF3">	#</span><span style="color:#79C0FF">0xfffc</span><span style="color:#E6EDF3">, </span><span style="color:#79C0FF">r14</span><span style="color:#8B949E">          ; move address fffc into f14</span></span>
<span class="line"><span style="color:#79C0FF">4464</span><span style="color:#E6EDF3">:  </span><span style="color:#79C0FF">0e54</span><span style="color:#FF7B72">           add</span><span style="color:#E6EDF3">	r4, </span><span style="color:#79C0FF">r14</span><span style="color:#8B949E">               ; this causes an overflow and r14 ends up being 43f8 which is also the stack pointer</span></span>
<span class="line"><span style="color:#79C0FF">4466</span><span style="color:#E6EDF3">:  </span><span style="color:#79C0FF">0e12</span><span style="color:#FF7B72">           push</span><span style="color:#79C0FF">	r14</span><span style="color:#8B949E">                   ; the second argument (the location to write a byte successful)</span></span>
<span class="line"><span style="color:#79C0FF">4468</span><span style="color:#E6EDF3">:  0f12           </span><span style="color:#FF7B72">push</span><span style="color:#79C0FF">	r15</span><span style="color:#8B949E">                   ; the first argument (the location of the password)</span></span>
<span class="line"><span style="color:#FFA198;font-style:italic">446a:</span><span style="color:#79C0FF">  3012</span><span style="color:#E6EDF3"> 7d00      </span><span style="color:#FF7B72">push</span><span style="color:#E6EDF3">	#</span><span style="color:#79C0FF">0x7d</span><span style="color:#8B949E">                 ; we know from the manual this calls the hsm-1 module and checks the password is correct</span></span>
<span class="line"><span style="color:#FFA198;font-style:italic">446e:</span><span style="color:#E6EDF3">  b012 7a45      </span><span style="color:#FF7B72">call</span><span style="color:#E6EDF3">	#</span><span style="color:#79C0FF">0x457a</span><span style="color:#E6EDF3"> &#x3C;</span><span style="color:#FF7B72">INT</span><span style="color:#E6EDF3">>         </span><span style="color:#8B949E">; it takes 2 arguments on stack and overwrites a memory location if flag is correct</span></span>
<span class="line"><span style="color:#79C0FF">4472</span><span style="color:#E6EDF3">:  5f44 fcff      </span><span style="color:#FF7B72">mov</span><span style="color:#E6EDF3">.b	-</span><span style="color:#79C0FF">0x4</span><span style="color:#E6EDF3">(r4), </span><span style="color:#79C0FF">r15</span><span style="color:#8B949E">         ; we previously set -0x4(r4) to zero, so set r15 to zero</span></span>
<span class="line"><span style="color:#79C0FF">4476</span><span style="color:#E6EDF3">:  8f11           sxt	</span><span style="color:#79C0FF">r15</span><span style="color:#8B949E">                   ; sign extend r15. in this case, 0 becomes 00</span></span>
<span class="line"><span style="color:#79C0FF">4478</span><span style="color:#E6EDF3">:  </span><span style="color:#79C0FF">3152</span><span style="color:#FF7B72">           add</span><span style="color:#E6EDF3">	#</span><span style="color:#79C0FF">0x8</span><span style="color:#E6EDF3">, </span><span style="color:#79C0FF">sp</span><span style="color:#8B949E">              ; return our stack to the previous value of r4, discarding our local variables</span></span>
<span class="line"><span style="color:#FFA198;font-style:italic">447a:</span><span style="color:#79C0FF">  3441</span><span style="color:#FF7B72">           pop</span><span style="color:#E6EDF3">	r4                    </span><span style="color:#8B949E">; restore r4</span></span>
<span class="line"><span style="color:#FFA198;font-style:italic">447c:</span><span style="color:#79C0FF">  3041</span><span style="color:#FF7B72">           ret</span><span style="color:#8B949E">                         ; return</span></span></code></pre><!----> <p>After analyzing test_password_valid, it looks like r15 is an error checking component that will return 0 under normal circumstance. Putting this all together, we can use the following payload to solve this challenge remembering to check the box for hex input.</p> <!----><pre class="shiki github-dark-default" style="background-color:#0d1117;color:#e6edf3" tabindex="0"><code><span class="line"><span>(padding)*16 + 0x9a: 000000000000000000000000000000009a</span></span></code></pre><!----><!----></div></div><!----><!----> <br> <div><hr></div><!----><!----><!--]--> <!--[!--><!--]--><!--]-->
			
			<script>
				{
					__sveltekit_zqainu = {
						base: new URL("..", location).pathname.slice(0, -1)
					};

					const element = document.currentScript.parentElement;

					Promise.all([
						import("../_app/immutable/entry/start.CA_wHMO-.js"),
						import("../_app/immutable/entry/app.TGZ1RBKz.js")
					]).then(([kit, app]) => {
						kit.start(app, element, {
							node_ids: [0, 4],
							data: [null,null],
							form: null,
							error: null
						});
					});
				}
			</script>
		</div>
	</body>
	
</html>
